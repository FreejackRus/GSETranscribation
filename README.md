# GSETranscription (Whisper + LLM)

Проект для автоматической обработки входящих голосовых сообщений, оставленных в системе Asterisk. Система транскрибирует аудио в текст, анализирует его с помощью языковой модели для извлечения структурированных данных и создает на их основе заявку в системе управления инцидентами GLPI.

## Архитектура

Проект состоит из нескольких ключевых модулей:

- **`scheduler.py`**: Основная точка входа. Запускает периодическую проверку новых аудиофайлов на SFTP-сервере.
- **`sftp_handler.py`**: Отвечает за взаимодействие с SFTP-сервером. Устанавливает соединение, ищет новые `.wav` файлы (при условии наличия соответствующего `.txt` файла с метаданными), загружает их, а после успешной обработки архивирует.
- **`asr.py` (Automatic Speech Recognition)**: Использует модель `faster-whisper` для транскрипции аудиофайлов. Перед распознаванием аудио конвертируется в формат 16 кГц моно.
- **`nlu.py` (Natural Language Understanding)**: Получает транскрибированный текст и с помощью языковой модели (LLM) извлекает из него структурированную информацию: номер поезда, номер вагона, серийный номер, описание проблемы и ФИО исполнителя. Реализован fallback-механизм на основе регулярных выражений на случай, если LLM не вернет валидный JSON.
- **`glpi_api.py`**: Обертка для работы с REST API GLPI. Отвечает за создание новой заявки (тикета) на основе данных, полученных от модуля NLU.
- **`main.py`**: Содержит основную логику обработки одного аудиофайла, координируя работу `asr`, `nlu` и `glpi_api`.
- **`config.py` / `config.yml`**: Файлы конфигурации. Содержат все необходимые настройки: доступы к SFTP и GLPI, пути к моделям и другие параметры.
- **`logger.py`**: Настраивает систему логирования для всего приложения.

### Схема работы

1.  `scheduler.py` по расписанию запускает `SFTPAudioProcessor`.
2.  `SFTPAudioProcessor` подключается к SFTP, ищет необработанные пары файлов `.wav` и `.txt`.
3.  Для каждого нового файла загружается аудио и метаданные.
4.  Вызывается функция `process_audio_file` из `main.py`.
5.  `asr.py` транскрибирует аудио в текст.
6.  `nlu.py` анализирует текст и извлекает данные.
7.  `glpi_api.py` создает заявку в GLPI.
8.  В случае успеха `SFTPAudioProcessor` архивирует обработанные файлы на SFTP-сервере и удаляет локальные копии.

## Конфигурация

Все основные параметры настраиваются в файле `config.py`, который содержит:
- Настройки подключения к SFTP и GLPI
- Пути к моделям
- Другие параметры системы

**Важно:** Этот файл содержит чувствительные данные и не должен попадать в систему контроля версий.

## Установка

Для установки зависимостей используйте `pipenv`:

```bash
# Установка зависимостей
pip install -r requirements.txt

# Для GPU версии
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118